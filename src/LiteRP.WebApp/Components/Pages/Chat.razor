@page "/chat/new/{CharacterIdForNewChat:guid}"
@page "/chat/{ChatSessionId:guid}"
@using LiteRP.Core.Services
@inject IChatSessionService ChatSessionService
@inject IToastService ToastService
@inject ICharacterService CharacterService
@inject ILogger<Chat> Logger
@inject NavigationManager Nav
@inject ISettingsService SettingsService
@inject OllamaStatusService OllamaStatusService

<PageTitle>LiteRP - Chat with @_character?.Name</PageTitle>

<div class="max-w-3xl mx-auto" style="flex-direction: column-reverse;">
    
    <div id="chat-container" class="d-flex flex-column flex-grow-1 space-y-3 pb-56" style="overflow-y: auto;">
        @foreach (var message in _chatMessageViewModels)
        {
            <ChatMessageView ChatMessage="message" />
        }
    </div>

    <div class="max-w-3xl mx-auto fixed bottom-6 left-0 right-0 md:left-64 items-end gap-2">
    
        @if (!_isAiConnected)
        {
            <LrpAlert Color="AlertColor.Danger" Class="mb-2 shadow-lg" ShowBorder>
                <HeaderContent>
                    Could not connect to the AI server. Please check your settings and ensure the server is running.
                </HeaderContent>
            </LrpAlert>
        }
        <div class="relative">
            <LrpInput TValue="string"
                      id="@InputId"
                      @bind-Value="_userInput"
                      Placeholder="Type a message… (Enter to send, Shift+Enter for newline)"
                      Lines="1"
                      MaxLines="20"
                      AutoGrow
                      Variant="LrpInputVariant.White"
                      InputClass="chat-input shadow-lg"/>
            @if (_isAiResponding)
            {
                <LrpButton Icon="IconTypes.StopSolid" Class="absolute bottom-3.5 right-3" OnClick="StopResponding"/>
            }
            else
            {
                <LrpButton Icon="IconTypes.PaperPlane" Class="absolute bottom-3.5 right-3" OnClick="SendMessage"
                           Disabled="!CanSendMessage" />
            }
        </div>
    </div>
</div>